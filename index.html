<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Seguimiento de Capacitaci√≥n - Nuevos Ingresos (Zonas Mejorado)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #4CAF50;
            --accent-color: #ff9800;
            --danger-color: #f44336;
            --light-color: #f5f5f5;
            --dark-color: #333;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height:1.6; color:#333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height:100vh; padding:20px;
        }
        .container { max-width:1400px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 10px30px rgba(0,0,0,0.1); overflow:hidden; }
        header { background:var(--primary-color); color:white; padding:25px; text-align:center; position:relative; }
        header h1 { font-size:28px; margin-bottom:10px; }
        header p { font-size:16px; opacity:.9; }
        .logo { position:absolute; top:20px; left:25px; font-size:24px; font-weight:bold; }
        .tabs { display:flex; background:#e8eaf6; padding:0 20px; overflow-x:auto; }
        .tab { padding:15px 25px; cursor:pointer; font-weight:500; transition:all .3s; border-bottom:3px solid transparent; white-space:nowrap; }
        .tab:hover { background:rgba(255,255,255,.5); }
        .tab.active { background:white; border-bottom:3px solid var(--primary-color); color:var(--primary-color); }
        .tab-content { display:none; padding:25px; }
        .tab-content.active { display:block; animation:fadeIn .5s ease; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .instructions { background:#f0f4f8; padding:20px; border-radius:10px; margin-bottom:25px; border-left:5px solid var(--primary-color); position:relative; }
        .instructions h3 { color:var(--primary-color); margin-bottom:15px; display:flex; align-items:center; }
        .instructions h3 i { margin-right:10px; }
        .stats-container { display:flex; justify-content:space-between; flex-wrap:wrap; margin:25px 0; gap:15px; }
        .stat-box { background:white; border-radius:10px; padding:20px; flex:1; min-width:200px; box-shadow:0 5px15px rgba(0,0,0,.05); text-align:center; border-top:4px solid var(--primary-color); transition:transform .3s ease; }
        .stat-box:hover { transform:translateY(-5px); }
        .stat-value { font-size:32px; font-weight:bold; color:var(--primary-color); margin:10px 0; }
        .stat-title { font-size:14px; color:#666; text-transform:uppercase; letter-spacing:1px; }
        .controls { display:flex; justify-content:flex-end; gap:10px; margin:20px 0; flex-wrap:wrap; align-items:center; }
        .filter-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: flex-start; margin-bottom: 10px; } 
        .btn { padding:12px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:500; transition:all .3s ease; display:flex; align-items:center; justify-content:center; }
        .btn i { margin-right:8px; font-size:16px; }
        .btn-sm { padding:8px 15px; font-size:14px; }
        .btn-primary { background:var(--primary-color); color:white; }
        .btn-primary:hover { background:#1e3d73; }
        .btn-success { background:var(--secondary-color); color:white; }
        .btn-success:hover { background:#3d8b40; }
        .btn-danger { background:var(--danger-color); color:white; }
        .btn-danger:hover { background:#d32f2f; }
        .btn-warning { background:var(--accent-color); color:white; }
        .btn-warning:hover { background:#e68900; }
        .btn-info { background:var(--info-color); color:white; }
        .btn-info:hover { background:#138496; }
        table { width:100%; border-collapse:collapse; margin:20px 0; box-shadow:0 5px15px rgba(0,0,0,.05); border-radius:10px; overflow:hidden; }
        th, td { padding:12px; text-align:center; border:1px solid #e0e0e0; }
        th { background:var(--primary-color); color:white; font-weight:600; position:sticky; top:0; }
        tr:nth-child(even) { background:#f9f9f9; }
        tr:hover { background:#f1f7ff; }
        .progress-cell { position:relative; }
        .progress-bar { height:20px; background:#f0f0f0; border-radius:10px; overflow:hidden; position:relative; }
        .progress-fill { height:100%; border-radius:10px; width:0%; transition:width .5s ease; }
        .progress-text { position:absolute; top:0; left:0; width:100%; text-align:center; font-weight:bold; color:#333; line-height:20px; font-size:12px; }
        input[type="checkbox"] { transform:scale(1.3); cursor:pointer; }
        input[type="number"], input[type="text"], input[type="date"], input[type="password"], select, textarea { padding:8px; border:1px solid #ddd; border-radius:5px; width:100%; }
        input[type="number"] { max-width: 80px; }
        /* Ajuste de ancho para el select en la tabla de evaluaciones */
        .evaluation-select-small { max-width: 60px; font-size: 12px; padding: 5px; }
        .expiring { background:#fff9e6; }
        .urgent { background:#ffe6e6; }
        .completed { background:#e6ffe6; }
        .save-notification, .error-notification { position:fixed; bottom:20px; right:20px; color:white; padding:15px 25px; border-radius:8px; box-shadow:0 5px15px rgba(0,0,0,.2); display:flex; align-items:center; animation:slideIn .3s ease; z-index:1000; }
        .save-notification { background:var(--secondary-color); }
        .error-notification { background:var(--danger-color); }
        @keyframes slideIn { from{ transform:translateX(100px); opacity:0 } to{ transform:translateX(0); opacity:1 } }
        .save-notification i, .error-notification i { margin-right:10px; font-size:20px; }
        .employee-name { font-weight:500; text-align:left; }
        .branch { background:#e8f5e9; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:500; }
        .action-btn { padding:6px 12px; border:none; border-radius:4px; cursor:pointer; margin:0 3px; }
        .delete-btn { background:var(--danger-color); color:white; }
        .delete-btn:hover { background:#d32f2f; }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:500; }
        .user-form { background:#f9f9f9; padding:20px; border-radius:10px; margin-bottom:20px; }
        .required-field::after { content:" *"; color:var(--danger-color); }
        .info-badge { position:absolute; top:10px; right:10px; background:var(--primary-color); color:white; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:500; }
        .feedback-date { font-size:12px; color:#666; margin-top:5px; }
        .feedback-status { display:inline-block; padding:3px 8px; border-radius:12px; font-size:12px; font-weight:500; }
        .status-pending { background:#fff3cd; color:#856404; }
        .status-completed { background:#d4edda; color:#155724; }
        .status-not-approved { background:#f8d7da; color:#721c24; }
        .status-en-proceso { background:#e0f7fa; color:#006064; } /* Nuevo color para 'En proceso' */
        .status-aprobado { background:#d4edda; color:#155724; }
        .status-no-aprobado { background:#f8d7da; color:#721c24; }
        .status-baja, .status-renuncia { background:#cccccc; color:#666; }
        
        .firebase-status { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold; 
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .firebase-connected { background: #d4edda; color: #155724; }
        .firebase-disconnected { background: #f8d7da; color: #721c24; }
        .firebase-offline { background: #fff3cd; color: #856404; }
        /* d√≠as */
        .days-critical { background-color: #ffcccc; }
        .days-warning { background-color: #fff2cc; }
        .days-normal { background-color: #e6ffe6; }
        .feedback-score { width: 60px; text-align: center; }
        .previous-workplace-input { width: 100px !important; font-size: 10px; padding: 4px; }
        .password-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .password-modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
        .password-modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .password-modal-close:hover { color: black; }
        .date-input-container { position: relative; }
        .date-format-hint { font-size: 12px; color: #666; margin-top: 4px; display: flex; align-items: center; gap: 5px; }
        .date-error { color: #d32f2f; font-size: 12px; margin-top: 5px; display: none; }
        .pdf-preview-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); overflow: auto; }
        .pdf-preview-content { background-color: #fefefe; margin: 20px auto; padding: 20px; width: 90%; max-width: 1000px; border-radius: 8px; position: relative; }
        .pdf-preview-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 20px; top: 15px; }
        .pdf-preview-close:hover { color: black; }
        .pdf-preview-container { width: 100%; height: 80vh; border: 1px solid #ddd; background: white; }
        .pdf-preview-actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        
        /* Nuevos estilos para ordenamiento */
        .sortable-header { cursor: pointer; position: relative; }
        .sortable-header:hover { background-color: rgba(255, 255, 255, 0.2); }
        .sortable-header::after {
            content: '';
            display: inline-block;
            margin-left: 5px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #fff;
            opacity: 0.5;
        }
        .sortable-header.asc::after {
            border-top: none;
            border-bottom: 5px solid #fff;
            opacity: 1;
        }
        .sortable-header.desc::after {
            opacity: 1;
        }

        /* Nuevos estilos para evaluaci√≥n */
        .evaluation-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .evaluation-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        .score-display {
            font-weight: bold;
            font-size: 16px;
        }
        .total-score {
            color: var(--primary-color);
        }
        .average-score {
            color: var(--secondary-color);
        }
        
        /* Nuevos estilos para login */
        .login-modal {
            display: flex;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }
        .login-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px15px rgba(0,0,0,0.3);
        }
        .login-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        .login-error {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .access-denied {
            opacity: 0.6;
            pointer-events: none;
        }
        .access-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        .status-inactive {
            background-color: #cccccc !important;
            color: #666;
        }
        
        /* Estilos para deshabilitar campos */
        .status-inactive input[type="checkbox"],
        .status-inactive input[type="number"],
        .status-inactive select:not(.evaluation-status-select), 
        .status-inactive input[type="text"]:not(.evaluation-status-select):not(.observation-input) { 
            pointer-events: none;
            opacity: 0.6;
        }
        
        /* Deshabilitar selects para usuarios sin permiso */
        .evaluation-select-small[disabled],
        .evaluation-status-select[disabled],
        .evaluation-text-input[disabled],
        .observation-input[disabled] {
            pointer-events: none;
            opacity: 0.6;
        }

        /* ************************************************************ */
        /* HABILITAR ESTATUS FINAL Y OBSERVACIONES INCLUSO SI EST√Å INACTIVO */
        /* ************************************************************ */
        .evaluation-status-select, .observation-input {
            pointer-events: auto !important;
            opacity: 1 !important;
        }
        /* ************************************************************ */
        
        /* Estilo para inputs de texto en la tabla de evaluaciones */
        .evaluation-text-input {
            width: 100px;
            font-size: 10px;
            padding: 4px;
            box-sizing: border-box; 
        }
        .observation-input {
            width: 100px; 
            font-size: 10px;
            padding: 4px;
            box-sizing: border-box;
            max-height: 50px; 
            overflow-y: auto;
        }

        /* ------------------------------------------------ */
        /* ‚ú® MEJORA PARA LA BARRA DESLIZADORA DE EVALUACIONES/AN√ÅLISIS */
        /* ------------------------------------------------ */
        .evaluation-table-wrapper {
            /* Contenedor para la tabla de evaluaciones que permite el scroll horizontal */
            overflow-x: auto;
        }
        /* ------------------------------------------------ */
        /* New Styles for Charts (simple horizontal bar chart) */
        .chart-bar-container { width: 100%; display: flex; flex-direction: column; gap: 5px; }
        .chart-bar-item { display: flex; align-items: center; font-size: 11px; }
        .chart-label { width: 80px; text-align: right; padding-right: 5px; color: #555; }
        .chart-bar-wrapper { flex: 1; height: 18px; background: #eee; border-radius: 3px; overflow: hidden; }
        .chart-bar-fill { height: 100%; transition: width 0.5s ease; display: flex; justify-content: flex-end; align-items: center; color: white; padding-right: 5px; font-weight: bold; }
        .chart-bar-fill.status-aprobado { background-color: var(--secondary-color); }
        .chart-bar-fill.status-no-aprobado { background-color: var(--danger-color); }
        .chart-bar-fill.status-en-proceso { background-color: var(--info-color); }
        .chart-bar-fill.status-baja, .chart-bar-fill.status-renuncia { background-color: #444; }
        .chart-bar-fill.progress-complete { background-color: var(--secondary-color); }
        .chart-bar-fill.progress-incomplete { background-color: var(--accent-color); }
        .chart-bar-fill.progress-pending { background-color: var(--danger-color); }

        @media (max-width:1200px) { .container { border-radius:10px; } .stats-container { flex-direction:column; } .stat-box { width:100%; } table { display:block; overflow-x:auto; } }
        @media (max-width:768px) { .tabs { flex-direction:column; } .tab { width:100%; text-align:center; } .controls { flex-direction:column; } .btn { width:100%; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h2 class="login-title">Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label for="login-email">Usuario (Email):</label>
                <input type="text" id="login-email" placeholder="usuario@prestocash.com">
            </div>
            <div class="form-group">
                <label for="login-password">Contrase√±a:</label>
                <input type="password" id="login-password" placeholder="Contrase√±a">
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="login()">Iniciar Sesi√≥n</button>
            <div id="login-error" class="login-error">
                <i class="fas fa-exclamation-circle"></i> Usuario o contrase√±a incorrectos
            </div>
        </div>
    </div>

    <div id="firebaseStatus" class="firebase-status firebase-disconnected">
        <i class="fas fa-exclamation-triangle"></i> Sin conexi√≥n a Firebase
    </div>

    <div class="container" id="main-container" style="display:none">
        <header>
            <div class="logo">CAP</div>
            <h1>Seguimiento de Capacitaci√≥n - Nuevos Ingresos (Zonas)</h1>
            <p>Sistema de monitoreo para el programa de capacitaci√≥n en Servicio al Cliente</p>
            <div class="user-info" id="userInfo">
                <i class="fas fa-user"></i>
                <span id="user-display">Usuario</span>
                <button class="logout-btn" onclick="logout()" title="Cerrar sesi√≥n">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="tabs" id="tabsBar">
            <div class="tab active" data-target="dashboard"><i class="fas fa-chart-line"></i> Dashboard Principal</div>
            <div class="tab" data-target="analytics"><i class="fas fa-chart-pie"></i> An√°lisis de Datos</div>
            <div class="tab" data-target="instructions"><i class="fas fa-info-circle"></i> Instrucciones</div>
            <div class="tab" data-target="evaluations"><i class="fas fa-clipboard-check"></i> Retroalimentaciones</div>
            <div class="tab" data-target="user-management"><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios</div>
            <div class="tab access-denied" data-target="administration" id="admin-tab">
                <i class="fas fa-toolbox"></i> Administraci√≥n
            </div>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="instructions">
                <h3><i class="fas fa-chart-line"></i> Panel de Seguimiento de Capacitaci√≥n</h3>
                <p>Esta hoja muestra el progreso de cada empleado en su capacitaci√≥n. Utilice los checkboxes para marcar los videos completados. <strong>Los datos se guardan autom√°ticamente en la nube con Firebase.</strong></p>
                <div class="info-badge">Total: <span id="employees-count">0</span> empleados</div>
            </div>

            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-title">Total Empleados Activos</div>
                    <div class="stat-value" id="total-active-employees">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Capacitaci√≥n Completada</div>
                    <div class="stat-value" id="completed-training">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Promedio de Progreso</div>
                    <div class="stat-value" id="average-progress">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Pr√≥ximos a Vencer</div>
                    <div class="stat-value" id="expiring-soon">0</div>
                </div>
            </div>

            <div class="controls">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="active-filter-dashboard" onchange="updateEmployeesTable()">
                    <label for="active-filter-dashboard" style="font-weight:600; cursor: pointer; user-select: none;">Solo En Proceso</label>
                </div>
                
                <label for="zone-filter-global" style="margin-right:8px; font-weight:600;">Filtrar Zona:</label>
                <select id="zone-filter-global" onchange="updateEmployeesTable()">
                    <option value="ALL">Todas</option>
                    <option value="ZONA 1">ZONA 1</option>
                    <option value="ZONA 2">ZONA 2</option>
                    <option value="ZONA 3">ZONA 3</option>
                    <option value="ZONA 4">ZONA 4</option>
                </select>

                <button class="btn btn-primary" onclick="exportToCSV()"><i class="fas fa-file-export"></i> Generar Reporte CSV</button>
                <button class="btn btn-info" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generar PDF</button>
                <button class="btn btn-success" onclick="window.print()"><i class="fas fa-print"></i> Imprimir Reporte</button>
                <button class="btn btn-warning" onclick="forceSaveNow()"><i class="fas fa-sync"></i> Forzar Sincronizaci√≥n</button>
            </div>

            <table id="main-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th class="sortable-header" onclick="sortTable('name')">Nombre de Empleado</th>
                        <th>Sucursal</th>
                        <th>Zona</th>
                        <th class="sortable-header" onclick="sortTable('startDate')">Fecha de Inicio</th>
                        <th>Fecha de T√©rmino</th>
                        <th>D√≠as Restantes</th>
                        <th>Curso SAC</th>
                        <th>Video 1</th>
                        <th>Video 2</th>
                        <th>Video 3</th>
                        <th>Video 4</th>
                        <th>Progreso Total</th>
                    </tr>
                </thead>
                <tbody id="employees-table-body"></tbody>
            </table>
        </div>

        <div id="analytics" class="tab-content">
            <div class="instructions">
                <h3><i class="fas fa-chart-pie"></i> An√°lisis y Control de Datos Detallado</h3>
                <p>Utilice los filtros para segmentar la informaci√≥n y obtener un an√°lisis profundo del desempe√±o y estatus de capacitaci√≥n y retroalimentaci√≥n.</p>
                <div class="info-badge">Total Filtrado: <span id="analytics-total-employees">0</span> empleados</div>
            </div>

            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-title">Personal con Exp. en Ventas</div>
                    <div class="stat-value" id="sales-experience-count">0</div>
                </div>
                <div class="stat-box" style="border-top:4px solid var(--secondary-color);">
                    <div class="stat-title">Promedio Calif. Retro. 1 (30 d√≠as)</div>
                    <div class="stat-value" id="avg-feedback1">0</div>
                </div>
                <div class="stat-box" style="border-top:4px solid var(--accent-color);">
                    <div class="stat-title">Promedio Calif. Retro. 2 (70 d√≠as)</div>
                    <div class="stat-value" id="avg-feedback2">0</div>
                </div>
                <div class="stat-box" style="border-top:4px solid var(--danger-color);">
                    <div class="stat-title">Personal de Baja / Renuncia</div>
                    <div class="stat-value" id="inactive-personnel">0</div>
                </div>
            </div>

            <div class="controls" style="justify-content: flex-start; flex-direction: row; align-items: flex-start; margin-top: 0; gap: 20px;">
                <div class="filter-group" style="flex-direction: column; align-items: stretch; border-right: 1px solid #eee; padding-right: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-filter"></i> Filtros de Contexto</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <label for="zone-filter-analytics" style="font-weight:600;">Zona:</label>
                        <select id="zone-filter-analytics" onchange="updateAnalyticsTab()" style="width: 100px;">
                            <option value="ALL">Todas</option>
                            <option value="ZONA 1">ZONA 1</option>
                            <option value="ZONA 2">ZONA 2</option>
                            <option value="ZONA 3">ZONA 3</option>
                            <option value="ZONA 4">ZONA 4</option>
                        </select>
                        <label for="status-filter-analytics" style="font-weight:600;">Estatus Final:</label>
                        <select id="status-filter-analytics" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="En proceso">En Proceso</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="No Aprobado">No Aprobado</option>
                            <option value="Baja">Baja</option>
                            <option value="Renuncia">Renuncia</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <label for="sales-exp-filter-analytics" style="font-weight:600;">Exp. Ventas:</label>
                        <select id="sales-exp-filter-analytics" onchange="updateAnalyticsTab()" style="width: 100px;">
                            <option value="ALL">Todos</option>
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                            <option value="PENDIENTE">Pendiente</option>
                        </select>
                        
                        <label for="previous-workplace-filter" style="font-weight:600;">Lugar Anterior:</label>
                        <select id="previous-workplace-filter" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="SPECIFIED">Especificado</option>
                            <option value="N/A">No Especificado</option>
                        </select>
                    </div>
                    
                    <h4 style="color: var(--primary-color); margin-top: 15px; margin-bottom: 10px;"><i class="fas fa-search"></i> B√∫squeda R√°pida</h4>
                    <div class="form-group" style="margin: 0;">
                        <input type="text" id="search-analytics" onkeyup="updateAnalyticsTab()" placeholder="üîç Buscar Nombre / Sucursal" style="padding: 6px; width: 100%;">
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="clearAnalyticsFilters()" style="margin-top: 10px;"><i class="fas fa-undo"></i> Limpiar Filtros</button>
                </div>
                
                <div class="filter-group" style="flex-direction: column; align-items: stretch; border-right: 1px solid #eee; padding-right: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-medal"></i> Filtros de Performance</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <label for="progress-filter-analytics" style="font-weight:600;">Progreso:</label>
                        <select id="progress-filter-analytics" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="COMPLETED">100% (Completo)</option>
                            <option value="INCOMPLETE">0-99% (Incompleto)</option>
                            <option value="PENDING">0% (Pendiente)</option>
                        </select>
                        
                        <label for="avg-score-filter-analytics" style="font-weight:600;">Promedio Calif:</label>
                        <select id="avg-score-filter-analytics" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="HIGH">Alto (80-100)</option>
                            <option value="MEDIUM">Medio (60-79)</option>
                            <option value="LOW">Bajo (0-59)</option>
                            <option value="N/A">N/A (Sin completar)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label for="feedback1-filter-analytics" style="font-weight:600;">Retro 1:</label>
                        <select id="feedback1-filter-analytics" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="COMPLETED">Completa</option>
                            <option value="PENDING">Pendiente</option>
                        </select>
                        <label for="feedback2-filter-analytics" style="font-weight:600;">Retro 2:</label>
                        <select id="feedback2-filter-analytics" onchange="updateAnalyticsTab()" style="width: 120px;">
                            <option value="ALL">Todos</option>
                            <option value="COMPLETED">Completa</option>
                            <option value="PENDING">Pendiente</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-group" style="flex-direction: column; flex-grow: 1; align-items: stretch;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Visualizaci√≥n de Datos (Filtrados)</h4>
                    <div id="analytics-charts-container" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div id="status-chart" style="flex: 1; min-width: 250px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Estatus Final</div>
                            </div>
                        <div id="progress-chart" style="flex: 1; min-width: 250px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Progreso Capacitaci√≥n</div>
                            </div>
                    </div>
                </div>
            </div>

            <div class="evaluation-table-wrapper"> 
                <table id="analytics-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Sucursal</th>
                            <th>Zona</th>
                            <th>Fecha Inicio</th>
                            <th>D√≠as Restantes</th>
                            <th>Exp. Ventas</th>
                            <th>Lugar Anterior</th>
                            <th>Progreso Total</th>
                            <th>Calif. Retro 1</th>
                            <th>Calif. Retro 2</th>
                            <th>Promedio Final</th>
                            <th>Estatus</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="instructions" class="tab-content">
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Instrucciones de Uso</h3>
                <p>Siga estas instrucciones para utilizar correctamente la plantilla de seguimiento de capacitaci√≥n:</p>
                <h4><i class="fas fa-video"></i> 1. Registro de Videos</h4>
                <p>En las columnas de "Video 1" a "Video 4", marque con un check (‚úì) cuando el empleado haya completado cada video.</p>
                <h4><i class="fas fa-graduation-cap"></i> 2. Curso SAC</h4>
                <p>Marque la casilla en la columna "Curso SAC" cuando el empleado haya completado el curso de Servicio al Cliente.</p>
                <h4><i class="fas fa-database"></i> 3. Sistema de Guardado</h4>
                <p>Los datos se guardan y sincronizan autom√°ticamente en la nube con Firebase. No es necesario guardar manualmente en un archivo local.</p>
                <h4><i class="fas fa-palette"></i> 5. C√≥digos de Color</h4>
                <ul>
                    <li><span style="background-color: #e6ffe6; padding: 2px 5px;">Fondo verde</span>: Capacitaci√≥n completada</li>
                    <li><span style="background-color: #fff9e6; padding: 2px 5px;">Fondo amarillo</span>: Menos de 10 d√≠as para retroalimentaci√≥n</li>
                    <li><span style="background-color: #ffe6e6; padding: 2px 5px;">Fondo rojo</span>: Retroalimentaci√≥n vencida</li>
                    <li><span style="background-color: #cccccc; padding: 2px 5px;">Fondo gris</span>: Empleado con estatus de Baja o Renuncia</li>
                </ul>
            </div>
        </div>

        <div id="evaluations" class="tab-content">
            <div class="instructions">
                <h3><i class="fas fa-clipboard-check"></i> Retroalimentaciones</h3>
                <p>Esta secci√≥n permite registrar y hacer seguimiento a las retroalimentaciones de los empleados durante su periodo de prueba de 90 d√≠as.</p>
                <div class="info-badge">Total: <span id="evaluations-count">0</span> empleados</div>
            </div>

            <div class="evaluation-controls">
                <div>
                    <label for="zone-filter-evaluations" style="margin-right:8px; font-weight:600;">Filtrar Zona:</label>
                    <select id="zone-filter-evaluations" onchange="updateEvaluationsTable()">
                        <option value="ALL">Todas</option>
                        <option value="ZONA 1">ZONA 1</option>
                        <option value="ZONA 2">ZONA 2</option>
                        <option value="ZONA 3">ZONA 3</option>
                        <option value="ZONA 4">ZONA 4</option>
                    </select>
                </div>
                <div class="evaluation-summary">
                    <div>Total empleados Activos: <span id="filtered-evaluations-count">0</span></div>
                    <div>Promedio general: <span id="general-average" class="score-display average-score">0</span></div>
                </div>
            </div>
            
            <div class="evaluation-table-wrapper"> 
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th class="sortable-header" onclick="sortEvaluationsTable('name')">Nombre</th>
                            <th>Sucursal</th>
                            <th>Zona</th>
                            <th class="sortable-header" onclick="sortEvaluationsTable('startDate')">Fecha Inicio</th>
                            <th>Fecha T√©rmino</th>
                            <th>D√≠as Restantes</th>
                            <th>Exp. Ventas</th> <th>Lugar Anterior</th> <th>Retro 1 (30 d√≠as)</th>
                            <th>Calificaci√≥n 1</th>
                            <th>Retro 2 (70 d√≠as)</th>
                            <th>Calificaci√≥n 2</th>
                            <th>Suma Total</th>
                            <th>Promedio</th>
                            <th>Estatus Final</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody id="evaluations-table-body"></tbody>
                </table>
            </div>
            </div>

        <div id="user-management" class="tab-content">
            <div class="access-warning" id="accessWarning">
                <i class="fas fa-exclamation-triangle"></i> Solo puede modificar empleados de su zona asignada.
            </div>
            <div class="instructions">
                <h3><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios</h3>
                <p>En esta secci√≥n puede agregar nuevos empleados al sistema de seguimiento o eliminar los existentes.</p>
                <div class="info-badge">Total: <span id="management-count">0</span> empleados</div>
            </div>

            <div class="user-form" id="userForm">
                <h4>Agregar Nuevo Empleado</h4>
                <div class="form-group">
                    <label for="new-name" class="required-field">Nombre completo:</label>
                    <input type="text" id="new-name" placeholder="Ej: Juan P√©rez L√≥pez">
                </div>
                <div class="form-group">
                    <label for="new-branch" class="required-field">Sucursal:</label>
                    <input type="text" id="new-branch" placeholder="Ej: VALLES-01">
                </div>
                <div class="form-group">
                    <label for="new-zone" class="required-field">Zona:</label>
                    <select id="new-zone">
                        <option value="ZONA 1">ZONA 1</option>
                        <option value="ZONA 2">ZONA 2</option>
                        <option value="ZONA 3">ZONA 3</option>
                        <option value="ZONA 4">ZONA 4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-start-date" class="required-field">Fecha de inicio:</label>
                    <div class="date-input-container">
                        <input type="date" id="new-start-date" onchange="updateEndDate()">
                        <div class="date-format-hint">
                            <i class="fas fa-info-circle"></i> Formato: AAAA-MM-DD
                        </div>
                        <div id="date-error" class="date-error">
                            <i class="fas fa-exclamation-circle"></i> Por favor ingrese una fecha v√°lida
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="new-end-date">Fecha de t√©rmino (se calcula autom√°ticamente):</label>
                    <input type="date" id="new-end-date" readonly>
                </div>
                <button class="btn btn-success" onclick="addEmployee()"><i class="fas fa-user-plus"></i> Agregar Empleado</button>
            </div>

            <h4>Lista de Empleados <small>(Ordenados por fecha de inicio)</small></h4>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th class="sortable-header" onclick="sortManagementTable('name')">Nombre</th>
                        <th>Sucursal</th>
                        <th>Zona</th>
                        <th class="sortable-header" onclick="sortManagementTable('startDate')">Fecha de Inicio</th>
                        <th>Fecha de T√©rmino</th>
                        <th>D√≠as Restantes</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="user-management-table-body"></tbody>
            </table>
        </div>

        <div id="administration" class="tab-content">
            <div class="instructions">
                <h3><i class="fas fa-toolbox"></i> Herramientas de Administraci√≥n</h3>
                <p>Esta secci√≥n contiene herramientas avanzadas para la gesti√≥n de la base de datos. Solo para usuarios con permisos de administrador.</p>
                <div class="info-badge">Acceso de administrador</div>
            </div>
            <div class="user-form">
                <h4>Copia de Seguridad y Restauraci√≥n</h4>
                <div class="controls" style="justify-content: flex-start; margin-top: 0;">
                    <button class="btn btn-primary" onclick="backupData()"><i class="fas fa-save"></i> Crear Copia de Seguridad (JSON)</button>
                    <div class="form-group" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                        <input type="file" id="restoreFile" accept=".json" style="width: auto;">
                        <button class="btn btn-warning" onclick="showPasswordModal('restore')"><i class="fas fa-upload"></i> Restaurar desde Copia</button>
                    </div>
                </div>
                <p style="margin-top: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                    <strong style="color: var(--danger-color);">Advertencia:</strong> La restauraci√≥n sobrescribir√° todos los datos existentes en la nube.
                </p>
            </div>
            <div class="user-form" style="margin-top: 25px;">
                <h4>Restablecer la Base de Datos</h4>
                <p>Esta acci√≥n eliminar√° todos los datos y restablecer√° el sistema a sus valores predeterminados.</p>
                <div class="controls" style="justify-content: flex-start; margin-top: 15px;">
                    <button class="btn btn-danger" onclick="showPasswordModal('reset')"><i class="fas fa-redo"></i> Borrar Datos y Restablecer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <span class="password-modal-close" onclick="closePasswordModal()">&times;</span>
            <h3 id="password-modal-title">Acceso de Administrador</h3>
            <p id="password-modal-message">Esta acci√≥n requiere permisos de administrador.</p>
            <div class="form-group">
                <label for="reset-password">Contrase√±a:</label>
                <input type="password" id="reset-password" placeholder="Ingrese la contrase√±a">
            </div>
            <button class="btn btn-danger" id="password-modal-button" onclick="confirmAction()">Confirmar</button>
            <p id="password-error" style="color: red; margin-top: 10px; display: none;">Contrase√±a incorrecta. Intente nuevamente.</p>
        </div>
    </div>

    <div id="pdfPreviewModal" class="pdf-preview-modal">
        <div class="pdf-preview-content">
            <span class="pdf-preview-close" onclick="closePdfPreview()">&times;</span>
            <h3>Vista Previa del Reporte PDF</h3>
            <div class="pdf-preview-container" id="pdf-preview-container">
                <iframe id="pdf-preview-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div class="pdf-preview-actions">
                <button class="btn btn-primary" onclick="downloadPDF()"><i class="fas fa-download"></i> Descargar PDF</button>
                <button class="btn btn-success" onclick="printPDF()"><i class="fas fa-print"></i> Imprimir</button>
                <button class="btn" onclick="closePdfPreview()">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="save-notification" id="saveNotification" style="display:none;"><i class="fas fa-check-circle"></i> <span id="notification-text"></span></div>
    <div class="error-notification" id="errorNotification" style="display:none;"><i class="fas fa-exclamation-circle"></i> <span id="error-text"></span></div>

    <script>
        // Inicializar jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        /* ===========================
           Datos y configuraci√≥n
           =========================== */
        let employees = [];
        let firebaseConnected = false;
        let lastSaveTime = null;
        let usingLocalStorage = false;
        let currentSort = { field: 'startDate', direction: 'asc' };
        let currentUser = null;
        let database;
        let employeesRef;
        let currentAction = ''; // Variable para controlar la acci√≥n del modal

        // Configuraci√≥n de usuarios y permisos - ACTUALIZADA
        const users = {
            "DAVID@UNIVERSIDADPRESTOCASH.MX": { password: "DAVIDZONA123", zone: "ZONA 1", name: "David" },
            "EDUARDO@UNIVERSIDADPRESTOCASH.MX": { password: "EDUARDOZONA245", zone: "ZONA 2", name: "Eduardo" },
            "LUNA@UNIVERSIDADPRESTOCASH.MX": { password: "LUNAZONA345", zone: "ZONA 3", name: "Luna" },
            "ALEX@UNIVERSIDADPRESTOCASH.MX": { password: "ALEX456", zone: "ZONA 4", name: "Alex" },
            "URISOL@UNIVERSIDADPRESTOCASH.MX": { password: "URISOLMASTER1", zone: "ALL", name: "Ursiol" },
            "EUGENIA@UNIVERSIDADPRESTOCASH.MX": { password: "EUGENIAMASTER2", zone: "ALL", name: "Eugenia" },
            "EDUARDO.MASTER@UNIVERSIDADPRESTOCASH.MX": { password: "EDUARDO.MASTER", zone: "ALL", name: "Eduardo Master" }
        };

        // Configuraci√≥n CORRECTA de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBDHj-dts63M2Vgvwag4YzTTYtk1I3-iN4",
            authDomain: "seguimiento-capacitacion.firebaseapp.com",
            databaseURL: "https://seguimiento-capacitacion-default-rtdb.firebaseio.com",
            projectId: "seguimiento-capacitacion",
            storageBucket: "seguimiento-capacitacion.firebasestorage.app",
            messagingSenderId: "789669982348",
            appId: "1:789669982348:web:0d6d20b48f933364964ba9"
        };

        /* ===========================
           UTILIDADES DE FECHAS (ZONA HORARIA FIJA / LOCAL)
           =========================== */

        // Parsear una fecha 'YYYY-MM-DD' a Date con hora local (evita interpretaci√≥n UTC)
        function parseDateFromInput(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // meses 0-11
            const day = parseInt(parts[2], 10);
            return new Date(year, month, day); // hora local a las 00:00
        }

        // Formatea un objeto Date a 'YYYY-MM-DD' usando su fecha local (no toISOString)
        function formatDateISO(date) {
            if (!date) return '';
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // Devuelve la fecha de "hoy" en 00:00 local (sin hora)
        function todayLocal() {
            const t = new Date();
            return new Date(t.getFullYear(), t.getMonth(), t.getDate());
        }

        // Formatea para mostrar en UI con toLocaleDateString en espa√±ol
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const d = parseDateFromInput(dateString);
            if (!d) return 'N/A';
            return d.toLocaleDateString('es-ES');
        }

        /* ===========================
           INICIALIZACI√ìN DE FIREBASE
           =========================== */
        function initializeFirebase() {
            try {
                console.log("Inicializando Firebase...");
                
                // Verificar si Firebase ya est√° inicializado
                if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                employeesRef = database.ref('employees');
                
                // Verificar estado de conexi√≥n
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("Conectado a Firebase");
                        updateFirebaseStatus(true);
                        firebaseConnected = true;
                        usingLocalStorage = false;
                        
                        // Configurar listeners de Firebase
                        setupFirebaseListeners();
                    } else {
                        console.log("Desconectado de Firebase");
                        updateFirebaseStatus(false);
                        firebaseConnected = false;
                        loadFromLocalStorage(); // Cargar datos locales como respaldo
                    }
                });
                
                return true;
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                updateFirebaseStatus(false);
                firebaseConnected = false;
                loadFromLocalStorage(); // Cargar datos locales como respaldo
                return false;
            }
        }

        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (!statusElement) return;
            
            if (connected) {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a Firebase';
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin conexi√≥n a Firebase - Usando almacenamiento local';
            }
        }

        function setupFirebaseListeners() {
            console.log("Configurando listener de Firebase Realtime Database para 'employees'.");
            
            employeesRef.on('value', (snapshot) => {
                console.log("Datos recibidos de Firebase.");
                const data = snapshot.val();
                
                if (data) {
                    console.log("Datos existentes en Firebase:", data);
                    // Convertir objeto a array
                    employees = Object.keys(data).map(key => {
                        const emp = data[key];
                        
                        // L√≥gica de normalizaci√≥n de hasSalesExperience:
                        let hasSalesExperienceValue = emp.hasSalesExperience;
                        if (hasSalesExperienceValue === undefined || hasSalesExperienceValue === null || hasSalesExperienceValue === '') {
                            hasSalesExperienceValue = 'PENDIENTE';
                        } else if (hasSalesExperienceValue === 'true' || hasSalesExperienceValue === true) {
                            hasSalesExperienceValue = true;
                        } else if (hasSalesExperienceValue === 'false' || hasSalesExperienceValue === false) {
                            hasSalesExperienceValue = false;
                        }
                        
                        return {
                            id: String(emp.id || key),
                            name: emp.name || '',
                            branch: emp.branch || '',
                            zone: emp.zone || 'ZONA 1',
                            startDate: emp.startDate || '',
                            endDate: emp.endDate || '',
                            sacCourse: emp.sacCourse || false,
                            video1: emp.video1 || false,
                            video2: emp.video2 || false,
                            video3: emp.video3 || false,
                            video4: emp.video4 || false,
                            feedback1: emp.feedback1 || 0,
                            feedback2: emp.feedback2 || 0,
                            feedback1Completed: emp.feedback1Completed || false,
                            feedback2Completed: emp.feedback2Completed || false,
                            status: emp.status || 'En proceso',
                            hasSalesExperience: hasSalesExperienceValue,
                            previousWorkplace: emp.previousWorkplace || '',
                            observations: emp.observations || '' 
                        };
                    });
                    
                    // Ordenar por fecha de inicio usando parseDateFromInput
                    employees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
                    
                    // Guardar en localStorage como respaldo
                    saveToLocalStorage();
                    
                    // Actualizar UI
                    updateUIAfterSave();
                    
                    showNotification('Datos cargados desde Firebase');
                } else {
                    console.log("No hay datos en Firebase. Cargando desde almacenamiento local.");
                    loadFromLocalStorage();
                }
            }, (error) => {
                console.error('Error al leer datos de Firebase:', error);
                showNotification('No se pudieron cargar los datos de Firebase: ' + error.message, true);
                loadFromLocalStorage();
            });
        }

        /* ===========================
           ALMACENAMIENTO LOCAL (FALLBACK)
           =========================== */
        function saveToLocalStorage() {
            try {
                localStorage.setItem('employeesData', JSON.stringify(employees));
                return true;
            } catch (e) {
                console.error('Error guardando en almacenamiento local:', e);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('employeesData');
                if (savedData) {
                    employees = JSON.parse(savedData);
                    // Normalizaci√≥n para datos guardados localmente
                    employees = employees.map(emp => {
                        let hasSalesExperienceValue = emp.hasSalesExperience;
                        if (hasSalesExperienceValue === undefined || hasSalesExperienceValue === null || hasSalesExperienceValue === '') {
                            hasSalesExperienceValue = 'PENDIENTE';
                        } else if (hasSalesExperienceValue === true || hasSalesExperienceValue === 'true') {
                            hasSalesExperienceValue = true;
                        } else if (hasSalesExperienceValue === 'false' || hasSalesExperienceValue === false) {
                            hasSalesExperienceValue = false;
                        }
                        return {
                            ...emp,
                            hasSalesExperience: hasSalesExperienceValue,
                            observations: emp.observations || '' 
                        };
                    });
                    
                    usingLocalStorage = true;
                    updateUIAfterSave();
                    showNotification('Datos cargados desde almacenamiento local', false);
                    return true;
                } else {
                    // Datos de ejemplo si no hay nada salvado
                    const startDate = todayLocal();
                    const endDate = new Date(startDate);
                    // 90 d√≠as contando el d√≠a de inicio => +89
                    endDate.setDate(endDate.getDate() + 89);
                    
                    employees = [{
                        id: "1",
                        name: "EJEMPLO - AGREGUE NUEVOS EMPLEADOS",
                        branch: "SUCURSAL-01",
                        zone: 'ZONA 1',
                        startDate: formatDateISO(startDate),
                        endDate: formatDateISO(endDate),
                        sacCourse: false,
                        video1: false,
                        video2: false,
                        video3: false,
                        video4: false,
                        feedback1: 0,
                        feedback2: 0,
                        feedback1Completed: false,
                        feedback2Completed: false,
                        status: 'En proceso',
                        hasSalesExperience: 'PENDIENTE', // Valor inicial por defecto
                        previousWorkplace: '',
                        observations: ''
                    }];
                    
                    updateUIAfterSave();
                    saveData();
                    showNotification('Base de datos vac√≠a, cargando datos de ejemplo');
                    return false;
                }
            } catch (e) {
                console.error('Error cargando desde almacenamiento local:', e);
                employees = [];
                updateUIAfterSave();
                showNotification('Error cargando datos locales', true);
                return false;
            }
        }

        /* ===========================
           FUNCIONES DE AUTENTICACI√ìN
           =========================== */
        function login() {
            const email = document.getElementById('login-email').value.trim().toUpperCase();
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            
            if (users[email] && users[email].password === password) {
                currentUser = {
                    email: email,
                    name: users[email].name,
                    zone: users[email].zone
                };
                
                // Guardar en localStorage para persistir la sesi√≥n
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Ocultar modal y mostrar aplicaci√≥n
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                
                // Actualizar UI con informaci√≥n del usuario
                document.getElementById('user-display').textContent = `${currentUser.name} (${currentUser.zone === 'ALL' ? 'Todas las zonas' : currentUser.zone})`;
                
                // Cargar datos
                loadData();
                
                // Ocultar error si existe
                errorElement.style.display = 'none';
            } else {
                errorElement.style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        function checkAccess(employeeZone) {
            if (!currentUser) return false;
            if (currentUser.zone === 'ALL') return true;
            return currentUser.zone === employeeZone;
        }

        function checkExistingSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Verificar que el usuario a√∫n existe en el sistema
                    if (users[currentUser.email] && users[currentUser.email].password) {
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('main-container').style.display = 'block';
                        document.getElementById('user-display').textContent = `${currentUser.name} (${currentUser.zone === 'ALL' ? 'Todas las zonas' : currentUser.zone})`;
                        loadData();
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                }
            }
            // Si no hay sesi√≥n v√°lida, mostrar login
            document.getElementById('loginModal').style.display = 'flex';
        }

        /* ===========================
           FUNCIONES PRINCIPALES
           =========================== */
        function loadData() {
            // Verificar permisos de zona para la gesti√≥n de usuarios
            const userManagementTab = document.getElementById('user-management');
            if (currentUser.zone === 'ALL') {
                userManagementTab.classList.remove('access-denied');
                document.getElementById('accessWarning').style.display = 'none';
            } else {
                userManagementTab.classList.remove('access-denied');
                document.getElementById('accessWarning').style.display = 'block';
            }
            // El formulario siempre debe mostrarse, pero con restricciones por zona
            document.getElementById('userForm').style.display = 'block';

            // Adem√°s, establecer la zona predeterminada en el formulario seg√∫n el usuario
            if (currentUser.zone !== 'ALL') {
                document.getElementById('new-zone').value = currentUser.zone;
                document.getElementById('new-zone').disabled = true;
            } else {
                document.getElementById('new-zone').disabled = false;
            }

            // Verificar y controlar acceso a la pesta√±a de administraci√≥n
            const adminTab = document.getElementById('admin-tab');
            if (currentUser.email === 'EDUARDO.MASTER@UNIVERSIDADPRESTOCASH.MX') {
                adminTab.classList.remove('access-denied');
            } else {
                adminTab.classList.add('access-denied');
            }
            
            // Inicializar Firebase y cargar datos
            initializeFirebase();
        }

        function updateUIAfterSave() {
            updateEmployeesTable();
            updateEvaluationsTable();
            updateUserManagementTable();
            updateStats();
            updateAnalyticsTab(); 
        }

        function updateEmployeesTable() {
            const tableBody = document.getElementById('employees-table-body');
            if (!tableBody) return;
            
            const zoneFilter = document.getElementById('zone-filter-global').value;
            const activeOnly = document.getElementById('active-filter-dashboard').checked; // NUEVA L√çNEA

            let filteredEmployees = employees;
            
            if (zoneFilter !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === zoneFilter);
            }
            
            // L√≥gica para filtrar solo "En proceso"
            if (activeOnly) {
                filteredEmployees = filteredEmployees.filter(emp => emp.status === 'En proceso');
            }
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
            
            tableBody.innerHTML = '';
            
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                const progress = calculateProgress(emp);
                const progressClass = getProgressClass(progress, daysRemaining, emp.status);

                // Solo deshabilitar la capacitaci√≥n si el estatus es Baja/Renuncia
                const isDisabled = emp.status === 'Baja' || emp.status === 'Renuncia' ? 'disabled' : '';
                if (isDisabled) {
                    daysRemaining = 0;
                }
                
                const row = document.createElement('tr');
                row.className = progressClass;
                
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="employee-name">${emp.name}</td>
                    <td><span class="branch">${emp.branch}</span></td>
                    <td>${emp.zone}</td>
                    <td>${formatDate(emp.startDate)}</td>
                    <td>${formatDate(emp.endDate)}</td>
                    <td class="${getDaysRemainingClass(daysRemaining)}">${daysRemaining}</td>
                    <td><input type="checkbox" ${emp.sacCourse ? 'checked' : ''} ${isDisabled} onchange="updateEmployeeField('${emp.id}', 'sacCourse', this.checked)"></td>
                    <td><input type="checkbox" ${emp.video1 ? 'checked' : ''} ${isDisabled} onchange="updateEmployeeField('${emp.id}', 'video1', this.checked)"></td>
                    <td><input type="checkbox" ${emp.video2 ? 'checked' : ''} ${isDisabled} onchange="updateEmployeeField('${emp.id}', 'video2', this.checked)"></td>
                    <td><input type="checkbox" ${emp.video3 ? 'checked' : ''} ${isDisabled} onchange="updateEmployeeField('${emp.id}', 'video3', this.checked)"></td>
                    <td><input type="checkbox" ${emp.video4 ? 'checked' : ''} ${isDisabled} onchange="updateEmployeeField('${emp.id}', 'video4', this.checked)"></td>
                    <td class="progress-cell">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%; background-color: ${getProgressColor(progress)}"></div>
                            <div class="progress-text">${progress}%</div>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('employees-count').textContent = filteredEmployees.length;
        }

        function updateEmployeeField(id, field, value) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                // Verificar permisos antes de actualizar
                if (!checkAccess(employee.zone)) {
                    showNotification("No tiene permisos para modificar empleados de esta zona", true);
                    // Restaurar el valor original
                    setTimeout(() => {
                        updateUIAfterSave();
                    }, 100);
                    return;
                }
                
                employee[field] = value;
                saveData();
            }
        }
        
        // Funci√≥n dedicada para actualizar observaciones o el estatus final
        function updateEvaluationField(id, field, value) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                 // Verificar permisos (solo si no es ALL, se verifica que sea su zona)
                if (!checkAccess(employee.zone)) {
                    showNotification("No tiene permisos para modificar este empleado", true);
                    // Restaurar el valor original si es un select (no necesario en input[text] si es observaci√≥n)
                    if (field === 'status') {
                        setTimeout(() => {
                            updateUIAfterSave();
                        }, 100);
                    }
                    return;
                }

                if (field === 'observations') {
                    // Mantener el texto original en may√∫sculas
                    employee[field] = toUpperCaseSafe(value); 
                } else {
                    employee[field] = value;
                }
                saveData();
            }
        }


        function updateEvaluationsTable() {
            const tableBody = document.getElementById('evaluations-table-body');
            if (!tableBody) return;
            
            const zoneFilter = document.getElementById('zone-filter-evaluations').value;
            let filteredEmployees = employees;
            
            if (zoneFilter !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === zoneFilter);
            }
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
            
            tableBody.innerHTML = '';
            
            let totalSum = 0;
            let totalCount = 0;
            
            // Filtrar los empleados que est√©n activos para el c√°lculo del promedio
            const activeEmployees = filteredEmployees.filter(emp => emp.status !== 'Baja' && emp.status !== 'Renuncia');
            
            // Calcular estad√≠sticas generales solo para empleados activos
            activeEmployees.forEach(emp => {
                if (emp.feedback1Completed && emp.feedback2Completed) {
                    totalSum += emp.feedback1 + emp.feedback2;
                    totalCount += 2;
                }
            });
            
            const generalAverage = totalCount > 0 ? (totalSum / totalCount).toFixed(1) : 0;
            
            // Actualizar estad√≠sticas generales
            document.getElementById('filtered-evaluations-count').textContent = activeEmployees.length;
            document.getElementById('general-average').textContent = generalAverage;
            
            // Renderizar la tabla con todos los empleados, pero aplicando los estilos
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                const progressClass = getProgressClass(0, 0, emp.status);
                
                const isStatusInactive = emp.status === 'Baja' || emp.status === 'Renuncia';
                // Verificar si el usuario tiene permiso para editar
                const canEdit = checkAccess(emp.zone);
                // Inhabilita los campos de entrenamiento/calif. si el estatus es Baja/Renuncia O si no tiene permiso.
                const isDisabledTraining = isStatusInactive || !canEdit ? 'disabled' : ''; 

                if (isStatusInactive) {
                    daysRemaining = 0;
                }

                const totalScore = emp.feedback1 + emp.feedback2;
                const totalCount = (emp.feedback1Completed ? 1 : 0) + (emp.feedback2Completed ? 1 : 0);
                const averageScore = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;

                const row = document.createElement('tr');
                row.className = progressClass;
                
                // Los selects de Estatus y Observaciones solo se deshabilitan si el usuario NO tiene permisos de zona.
                const isStatusObservationDisabled = !canEdit ? 'disabled' : '';
                
                // Determinar el valor seleccionado para 'Exp. Ventas'
                let salesExpValue = emp.hasSalesExperience;
                let salesExpSelectedPendiente = salesExpValue === 'PENDIENTE' ? 'selected' : '';
                let salesExpSelectedSi = salesExpValue === true ? 'selected' : '';
                let salesExpSelectedNo = salesExpValue === false ? 'selected' : '';

                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="employee-name">${emp.name}</td>
                    <td><span class="branch">${emp.branch}</span></td>
                    <td>${emp.zone}</td>
                    <td>${formatDate(emp.startDate)}</td>
                    <td>${formatDate(emp.endDate)}</td>
                    <td class="${getDaysRemainingClass(daysRemaining)}">${daysRemaining}</td>
                    <td>
                        <select class="evaluation-select-small" ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'hasSalesExperience', this.value === 'true' ? true : (this.value === 'false' ? false : 'PENDIENTE'))">
                            <option value="PENDIENTE" ${salesExpSelectedPendiente}>Pendiente</option>
                            <option value="true" ${salesExpSelectedSi}>S√≠</option>
                            <option value="false" ${salesExpSelectedNo}>No</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" value="${emp.previousWorkplace || ''}" class="evaluation-text-input" placeholder="Lugar" 
                               maxlength="30" ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'previousWorkplace', toUpperCaseSafe(this.value))">
                    </td>
                    <td>
                        <input type="checkbox" ${emp.feedback1Completed ? 'checked' : ''} ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'feedback1Completed', this.checked)">
                        <div class="feedback-date">${getFeedbackDate(emp.startDate, 30)}</div>
                    </td>
                    <td>
                        <input type="number" min="0" max="100" step="1" value="${emp.feedback1}" class="feedback-score" ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'feedback1', parseFloat(this.value) || 0)">
                    </td>
                    <td>
                        <input type="checkbox" ${emp.feedback2Completed ? 'checked' : ''} ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'feedback2Completed', this.checked)">
                        <div class="feedback-date">${getFeedbackDate(emp.startDate, 70)}</div>
                    </td>
                    <td>
                        <input type="number" min="0" max="100" step="1" value="${emp.feedback2}" class="feedback-score" ${isDisabledTraining} onchange="updateEmployeeField('${emp.id}', 'feedback2', parseFloat(this.value) || 0)">
                    </td>
                    <td class="total-score">${totalScore}</td>
                    <td class="average-score">${averageScore}</td>
                    <td>
                        <select onchange="updateEvaluationField('${emp.id}', 'status', this.value)" class="evaluation-status-select" ${isStatusObservationDisabled}>
                            <option value="Aprobado" ${emp.status === 'Aprobado' ? 'selected' : ''}>Aprobado</option>
                            <option value="No Aprobado" ${emp.status === 'No Aprobado' ? 'selected' : ''}>No Aprobado</option>
                            <option value="Baja" ${emp.status === 'Baja' ? 'selected' : ''}>Baja</option>
                            <option value="Renuncia" ${emp.status === 'Renuncia' ? 'selected' : ''}>Renuncia</option>
                            <option value="En proceso" ${emp.status === 'En proceso' ? 'selected' : ''}>En proceso</option>
                        </select>
                    </td>
                    <td>
                        <textarea class="observation-input" placeholder="Observaciones" rows="3" 
                                  onchange="updateEvaluationField('${emp.id}', 'observations', this.value)" 
                                  ${isStatusObservationDisabled}>${emp.observations || ''}</textarea>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('evaluations-count').textContent = filteredEmployees.length;
        }

        function updateUserManagementTable() {
            const tableBody = document.getElementById('user-management-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Filtrar empleados por zona si el usuario no tiene acceso completo
            let filteredEmployees = employees;
            if (currentUser.zone !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === currentUser.zone);
            }
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
            
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                const progressClass = getProgressClass(0, 0, emp.status);

                if (progressClass === 'status-inactive') {
                    daysRemaining = 0;
                }
                
                const row = document.createElement('tr');
                row.className = progressClass;
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="employee-name">${emp.name}</td>
                    <td><span class="branch">${emp.branch}</span></td>
                    <td>${emp.zone}</td>
                    <td>${formatDate(emp.startDate)}</td>
                    <td>${formatDate(emp.endDate)}</td>
                    <td class="${getDaysRemainingClass(daysRemaining)}">${daysRemaining}</td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteEmployee('${emp.id}')" ${!checkAccess(emp.zone) ? 'disabled' : ''}><i class="fas fa-trash"></i> Eliminar</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('management-count').textContent = filteredEmployees.length;
        }

        function updateStats() {
            // Filtrar empleados activos para los c√°lculos
            const zoneFilter = document.getElementById('zone-filter-global').value;
            let employeesForStats = employees.filter(emp => emp.status !== 'Baja' && emp.status !== 'Renuncia');
            
            if (zoneFilter !== 'ALL') {
                employeesForStats = employeesForStats.filter(emp => emp.zone === zoneFilter);
            }
            
            const totalActiveEmployees = employeesForStats.length;
            
            document.getElementById('total-active-employees').textContent = totalActiveEmployees;
            
            if (totalActiveEmployees === 0) {
                document.getElementById('completed-training').textContent = '0%';
                document.getElementById('average-progress').textContent = '0%';
                document.getElementById('expiring-soon').textContent = '0';
                return;
            }
            
            // Calcular porcentaje de capacitaci√≥n completada
            const completedCount = employeesForStats.filter(emp => {
                return emp.sacCourse && emp.video1 && emp.video2 && emp.video3 && emp.video4;
            }).length;
            
            const completedPercentage = Math.round((completedCount / totalActiveEmployees) * 100);
            document.getElementById('completed-training').textContent = `${completedPercentage}%`;
            
            // Calcular progreso promedio
            const totalProgress = employeesForStats.reduce((sum, emp) => sum + calculateProgress(emp), 0);
            const averageProgress = Math.round(totalProgress / totalActiveEmployees);
            document.getElementById('average-progress').textContent = `${averageProgress}%`;
            
            // Calcular empleados pr√≥ximos a vencer (menos de 15 d√≠as)
            const today = todayLocal();
            const expiringSoonCount = employeesForStats.filter(emp => {
                const endDate = parseDateFromInput(emp.endDate);
                const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                return daysRemaining < 15 && daysRemaining > 0;
            }).length;
            
            document.getElementById('expiring-soon').textContent = expiringSoonCount;
        }

        /* ===========================
           AN√ÅLISIS DE DATOS - FUNCIONES
           =========================== */

        function getEmployeeAverageScore(emp) {
            const totalScore = emp.feedback1 + emp.feedback2;
            const totalCount = (emp.feedback1Completed ? 1 : 0) + (emp.feedback2Completed ? 1 : 0);
            return totalCount > 0 ? (totalScore / totalCount) : null; // Retorna null si no hay retroalimentaciones completadas
        }

        function updateAnalyticsTab() {
            const tableBody = document.getElementById('analytics-table-body');
            if (!tableBody) return;

            // Obtener todos los valores de filtro
            const zoneFilter = document.getElementById('zone-filter-analytics').value;
            const statusFilter = document.getElementById('status-filter-analytics').value;
            const salesExpFilter = document.getElementById('sales-exp-filter-analytics').value;
            const previousWorkplaceFilter = document.getElementById('previous-workplace-filter').value;
            const progressFilter = document.getElementById('progress-filter-analytics').value;
            const avgScoreFilter = document.getElementById('avg-score-filter-analytics').value;
            const feedback1Filter = document.getElementById('feedback1-filter-analytics').value;
            const feedback2Filter = document.getElementById('feedback2-filter-analytics').value;
            const searchName = document.getElementById('search-analytics').value.trim().toUpperCase();

            // 1. Filtrado de Empleados (Filtro compuesto)
            let filteredEmployees = employees.filter(emp => {
                const empProgress = calculateProgress(emp);
                const empAvgScore = getEmployeeAverageScore(emp);
                
                // Zona
                if (zoneFilter !== 'ALL' && emp.zone !== zoneFilter) return false;
                
                // Estatus Final
                if (statusFilter !== 'ALL' && emp.status !== statusFilter) return false;
                
                // Experiencia en Ventas
                if (salesExpFilter !== 'ALL') {
                    if (salesExpFilter === 'true' && emp.hasSalesExperience !== true) return false;
                    if (salesExpFilter === 'false' && emp.hasSalesExperience !== false) return false;
                    if (salesExpFilter === 'PENDIENTE' && emp.hasSalesExperience !== 'PENDIENTE') return false;
                }
                
                // Lugar Anterior 
                if (previousWorkplaceFilter !== 'ALL') {
                    const hasWorkplace = emp.previousWorkplace && emp.previousWorkplace.trim().length > 0;
                    if (previousWorkplaceFilter === 'SPECIFIED' && !hasWorkplace) return false;
                    if (previousWorkplaceFilter === 'N/A' && hasWorkplace) return false;
                }

                // Progreso de Capacitaci√≥n
                if (progressFilter !== 'ALL') {
                    if (progressFilter === 'COMPLETED' && empProgress !== 100) return false;
                    if (progressFilter === 'INCOMPLETE' && (empProgress === 100 || empProgress === 0)) return false;
                    if (progressFilter === 'PENDING' && empProgress !== 0) return false;
                }

                // Estatus Retroalimentaci√≥n 1
                if (feedback1Filter !== 'ALL') {
                    if (feedback1Filter === 'COMPLETED' && emp.feedback1Completed !== true) return false;
                    if (feedback1Filter === 'PENDING' && emp.feedback1Completed !== false) return false;
                }
                
                // Estatus Retroalimentaci√≥n 2
                if (feedback2Filter !== 'ALL') {
                    if (feedback2Filter === 'COMPLETED' && emp.feedback2Completed !== true) return false;
                    if (feedback2Filter === 'PENDING' && emp.feedback2Completed !== false) return false;
                }

                // Promedio de Calificaci√≥n (Solo si hay una calificaci√≥n v√°lida)
                if (avgScoreFilter !== 'ALL') {
                    if (avgScoreFilter === 'N/A' && empAvgScore !== null) return false;
                    if (empAvgScore !== null) {
                        if (avgScoreFilter === 'HIGH' && (empAvgScore < 80 || empAvgScore > 100)) return false;
                        if (avgScoreFilter === 'MEDIUM' && (empAvgScore < 60 || empAvgScore >= 80)) return false;
                        if (avgScoreFilter === 'LOW' && (empAvgScore >= 0 && empAvgScore < 60)) return false;
                    } else if (avgScoreFilter !== 'N/A') {
                        return false; 
                    }
                }

                // B√∫squeda por Nombre / Sucursal
                if (searchName) {
                    if (!emp.name.toUpperCase().includes(searchName) && !emp.branch.toUpperCase().includes(searchName)) return false;
                }

                return true;
            });
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));

            document.getElementById('analytics-total-employees').textContent = filteredEmployees.length;

            // 2. C√°lculo de Estad√≠sticas y Gr√°ficos
            let salesExperienceCount = 0;
            let sumFeedback1 = 0;
            let countFeedback1 = 0;
            let sumFeedback2 = 0;
            let countFeedback2 = 0;
            let inactiveCount = 0;
            
            const statusCounts = { 'Aprobado': 0, 'No Aprobado': 0, 'En proceso': 0, 'Baja': 0, 'Renuncia': 0 };
            const progressCounts = { 'COMPLETED': 0, 'INCOMPLETE': 0, 'PENDING': 0 };


            filteredEmployees.forEach(emp => {
                const empProgress = calculateProgress(emp);
                
                // Stat Boxes
                if (emp.hasSalesExperience === true) {
                    salesExperienceCount++;
                }
                if (emp.status === 'Baja' || emp.status === 'Renuncia') {
                    inactiveCount++;
                }
                if (emp.feedback1Completed) {
                    sumFeedback1 += emp.feedback1;
                    countFeedback1++;
                }
                if (emp.feedback2Completed) {
                    sumFeedback2 += emp.feedback2;
                    countFeedback2++;
                }
                
                // Chart Data - Status
                if (statusCounts.hasOwnProperty(emp.status)) {
                    statusCounts[emp.status]++;
                } else {
                    statusCounts[emp.status] = 1; 
                }

                // Chart Data - Progress
                if (empProgress === 100) {
                    progressCounts['COMPLETED']++;
                } else if (empProgress > 0) {
                    progressCounts['INCOMPLETE']++;
                } else {
                    progressCounts['PENDING']++;
                }
            });

            // Actualizar Stats Boxes
            const avgFeedback1 = countFeedback1 > 0 ? (sumFeedback1 / countFeedback1).toFixed(1) : 'N/A';
            const avgFeedback2 = countFeedback2 > 0 ? (sumFeedback2 / countFeedback2).toFixed(1) : 'N/A';
            
            document.getElementById('sales-experience-count').textContent = salesExperienceCount;
            document.getElementById('avg-feedback1').textContent = avgFeedback1;
            document.getElementById('avg-feedback2').textContent = avgFeedback2;
            document.getElementById('inactive-personnel').textContent = inactiveCount;
            
            // Renderizar Gr√°ficos
            renderAnalyticsCharts(filteredEmployees.length, statusCounts, progressCounts);


            // 3. Renderizado de la Tabla
            tableBody.innerHTML = '';
            
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                const progress = calculateProgress(emp);
                const empAvgScore = getEmployeeAverageScore(emp);
                const averageScore = empAvgScore !== null ? empAvgScore.toFixed(1) : 'N/A';
                
                const progressClass = getProgressClass(0, 0, emp.status);
                
                if (emp.status === 'Baja' || emp.status === 'Renuncia') {
                    daysRemaining = 0;
                }

                // Formatear Exp. Ventas
                let salesExpText;
                if (emp.hasSalesExperience === true) {
                    salesExpText = 'S√≠';
                } else if (emp.hasSalesExperience === false) {
                    salesExpText = 'No';
                } else {
                    salesExpText = 'PENDIENTE';
                }

                // Clase para el promedio final (para resaltar)
                let avgScoreClass = '';
                if (empAvgScore !== null) {
                    if (empAvgScore < 60) {
                        avgScoreClass = 'days-critical';
                    } else if (empAvgScore < 80) {
                        avgScoreClass = 'days-warning';
                    } else {
                        avgScoreClass = 'days-normal';
                    }
                }

                const workplaceDisplay = emp.previousWorkplace && emp.previousWorkplace.trim().length > 0 ? emp.previousWorkplace : 'N/A';
                
                const row = document.createElement('tr');
                row.className = progressClass;
                
                row.innerHTML = `
                    <td>${emp.id}</td>
                    <td class="employee-name">${emp.name}</td>
                    <td><span class="branch">${emp.branch}</span></td>
                    <td>${emp.zone}</td>
                    <td>${formatDate(emp.startDate)}</td>
                    <td class="${getDaysRemainingClass(daysRemaining)}">${daysRemaining}</td>
                    <td>${salesExpText}</td>
                    <td>${workplaceDisplay}</td>
                    <td class="progress-cell">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%; background-color: ${getProgressColor(progress)}"></div>
                            <div class="progress-text">${progress}%</div>
                        </div>
                    </td>
                    <td>${emp.feedback1Completed ? emp.feedback1 : 'N/A'}</td>
                    <td>${emp.feedback2Completed ? emp.feedback2 : 'N/A'}</td>
                    <td class="${avgScoreClass}">${averageScore}</td>
                    <td><span class="feedback-status status-${emp.status.toLowerCase().replace(/ /g, '-')}">${emp.status}</span></td>
                    <td>${emp.observations || 'N/A'}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function renderAnalyticsCharts(totalFiltered, statusCounts, progressCounts) {
            const statusChartContainer = document.getElementById('status-chart');
            const progressChartContainer = document.getElementById('progress-chart');
            
            if (!statusChartContainer || !progressChartContainer) return;
            
            // --- Chart Status ---
            let statusHtml = '<div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Estatus Final</div><div class="chart-bar-container">';
            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const percentage = totalFiltered > 0 ? ((count / totalFiltered) * 100).toFixed(0) : 0;
                const statusClass = `status-${status.toLowerCase().replace(/ /g, '-')}`;
                if (count > 0) {
                    statusHtml += `
                        <div class="chart-bar-item">
                            <span class="chart-label">${status} (${percentage}%)</span>
                            <div class="chart-bar-wrapper">
                                <div class="chart-bar-fill ${statusClass}" style="width: ${percentage}%">${count}</div>
                            </div>
                        </div>
                    `;
                }
            });
            statusHtml += '</div>';
            statusChartContainer.innerHTML = statusHtml;

            // --- Chart Progress ---
            let progressHtml = '<div style="font-weight: bold; margin-bottom: 5px; font-size: 14px;">Progreso Capacitaci√≥n</div><div class="chart-bar-container">';
            const progressLabels = {
                'COMPLETED': '100% Completo',
                'INCOMPLETE': '0-99% Incompleto',
                'PENDING': '0% Pendiente'
            };
            Object.keys(progressCounts).forEach(progressKey => {
                const count = progressCounts[progressKey];
                const percentage = totalFiltered > 0 ? ((count / totalFiltered) * 100).toFixed(0) : 0;
                const progressClass = `progress-${progressKey.toLowerCase()}`;
                if (count > 0) {
                    progressHtml += `
                        <div class="chart-bar-item">
                            <span class="chart-label">${progressLabels[progressKey]} (${percentage}%)</span>
                            <div class="chart-bar-wrapper">
                                <div class="chart-bar-fill ${progressClass}" style="width: ${percentage}%">${count}</div>
                            </div>
                        </div>
                    `;
                }
            });
            progressHtml += '</div>';
            progressChartContainer.innerHTML = progressHtml;
        }

        function clearAnalyticsFilters() {
            document.getElementById('zone-filter-analytics').value = 'ALL';
            document.getElementById('status-filter-analytics').value = 'ALL';
            document.getElementById('sales-exp-filter-analytics').value = 'ALL';
            document.getElementById('previous-workplace-filter').value = 'ALL'; 
            document.getElementById('progress-filter-analytics').value = 'ALL';
            document.getElementById('avg-score-filter-analytics').value = 'ALL';
            document.getElementById('feedback1-filter-analytics').value = 'ALL';
            document.getElementById('feedback2-filter-analytics').value = 'ALL'; 
            document.getElementById('search-analytics').value = '';
            updateAnalyticsTab();
            showNotification('Filtros de An√°lisis restablecidos');
        }


        /* ===========================
           FUNCIONES AUXILIARES EXISTENTES
           =========================== */

        function calculateProgress(employee) {
            let progress = 0;
            if (employee.sacCourse) progress += 20;
            if (employee.video1) progress += 20;
            if (employee.video2) progress += 20;
            if (employee.video3) progress += 20;
            if (employee.video4) progress += 20;
            return progress;
        }

        function getProgressClass(progress, daysRemaining, status) {
            if (status === 'Baja' || status === 'Renuncia') return 'status-inactive';
            if (progress === 100) return 'completed';
            if (daysRemaining < 0) return 'urgent';
            if (daysRemaining < 10) return 'expiring';
            return '';
        }

        function getDaysRemainingClass(daysRemaining) {
            if (daysRemaining < 0) return 'days-critical';
            if (daysRemaining < 15) return 'days-warning';
            return 'days-normal';
        }

        function getProgressColor(progress) {
            if (progress === 100) return '#4CAF50';
            if (progress >= 80) return '#8BC34A';
            if (progress >= 60) return '#CDDC39';
            if (progress >= 40) return '#FFC107';
            if (progress >= 20) return '#FF9800';
            return '#F44336';
        }

        function getFeedbackDate(startDate, daysAfter) {
            const date = parseDateFromInput(startDate);
            if (!date) return 'N/A';
            date.setDate(date.getDate() + daysAfter);
            return formatDateISO(date);
        }

        /* ===========================
           GESTI√ìN DE EMPLEADOS
           =========================== */
        function addEmployee() {
            const name = document.getElementById('new-name').value.trim();
            const branch = document.getElementById('new-branch').value.trim();
            const zone = document.getElementById('new-zone').value;
            const startDateInput = document.getElementById('new-start-date').value;
            
            if (!name || !branch || !startDateInput) {
                showNotification('Por favor complete todos los campos obligatorios', true);
                return;
            }
            
            // Validar formato de fecha
            if (!isValidDate(startDateInput)) {
                document.getElementById('date-error').style.display = 'block';
                return;
            } else {
                document.getElementById('date-error').style.display = 'none';
            }
            
            // Verificar permisos para agregar empleados en esta zona
            if (currentUser.zone !== 'ALL' && currentUser.zone !== zone) {
                showNotification('Solo puede agregar empleados a su zona asignada', true);
                return;
            }
            
            // Calcular fecha de t√©rmino: 90 d√≠as contando el d√≠a de inicio => +89
            const startDate = parseDateFromInput(startDateInput);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 89); // +89 para que inclusive contemos 90 d√≠as
            
            // Obtener el siguiente ID (asegurando enteros)
            const nextId = employees.length > 0 ? (Math.max(...employees.map(e => Number(e.id || 0))) + 1) : 1;
            
            const newEmployee = {
                id: String(nextId),
                name: name.toUpperCase(),
                branch: branch.toUpperCase(),
                zone: zone,
                startDate: formatDateISO(startDate),
                endDate: formatDateISO(endDate),
                sacCourse: false,
                video1: false,
                video2: false,
                video3: false,
                video4: false,
                feedback1: 0,
                feedback2: 0,
                feedback1Completed: false,
                feedback2Completed: false,
                status: 'En proceso',
                hasSalesExperience: 'PENDIENTE', // Valor inicial por defecto
                previousWorkplace: '',
                observations: '', // NUEVO CAMPO
            };
            
            employees.push(newEmployee);
            saveData();
            
            // Limpiar formulario
            document.getElementById('new-name').value = '';
            document.getElementById('new-branch').value = '';
            document.getElementById('new-start-date').value = '';
            document.getElementById('new-end-date').value = '';
            
            showNotification('Empleado agregado correctamente');
        }

        function deleteEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            
            if (!employee) return;
            
            // Verificar permisos
            if (!checkAccess(employee.zone)) {
                showNotification('No tiene permisos para eliminar empleados de esta zona', true);
                return;
            }
            
            if (!confirm('¬øEst√° seguro de que desea eliminar este empleado? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            employees = employees.filter(emp => emp.id !== id);
            saveData();
            showNotification('Empleado eliminado correctamente');
        }

        function updateEndDate() {
            const startDateInput = document.getElementById('new-start-date');
            const endDateInput = document.getElementById('new-end-date');
            
            if (startDateInput.value) {
                if (!isValidDate(startDateInput.value)) {
                    document.getElementById('date-error').style.display = 'block';
                    endDateInput.value = '';
                    return;
                }
                document.getElementById('date-error').style.display = 'none';
                const startDate = parseDateFromInput(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 89); // +89 para incluir el d√≠a inicial
                endDateInput.value = formatDateISO(endDate);
            } else {
                endDateInput.value = '';
            }
        }

        function isValidDate(dateString) {
            const regEx = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regEx)) return false;
            const parts = dateString.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            const d = new Date(year, month - 1, day);
            return d && (d.getFullYear() === year) && (d.getMonth() + 1 === month) && (d.getDate() === day);
        }

        /* ===========================
           ORDENAMIENTO DE TABLAS
           =========================== */
        function sortTable(field) {
            // Cambiar direcci√≥n si es el mismo campo
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Actualizar indicadores visuales en los encabezados
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            const currentHeader = document.querySelector(`.sortable-header[onclick="sortTable('${field}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(currentSort.direction);
            }
            
            // Aplicar ordenamiento
            employees.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;
                    case 'startDate':
                        valueA = parseDateFromInput(a.startDate) || todayLocal();
                        valueB = parseDateFromInput(b.startDate) || todayLocal();
                        break;
                    default:
                        valueA = a[field];
                        valueB = b[field];
                }
                
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            updateUIAfterSave();
        }

        function sortEvaluationsTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            const currentHeader = document.querySelector(`.sortable-header[onclick="sortEvaluationsTable('${field}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(currentSort.direction);
            }
            
            employees.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;
                    case 'startDate':
                        valueA = parseDateFromInput(a.startDate) || todayLocal();
                        valueB = parseDateFromInput(b.startDate) || todayLocal();
                        break;
                    default:
                        valueA = a[field];
                        valueB = b[field];
                }
                
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            updateUIAfterSave();
        }

        function sortManagementTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            
            const currentHeader = document.querySelector(`.sortable-header[onclick="sortManagementTable('${field}')"]`);
            if (currentHeader) {
                currentHeader.classList.add(currentSort.direction);
            }
            
            employees.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;
                    case 'startDate':
                        valueA = parseDateFromInput(a.startDate) || todayLocal();
                        valueB = parseDateFromInput(b.startDate) || todayLocal();
                        break;
                    default:
                        valueA = a[field];
                        valueB = b[field];
                }
                
                if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            updateUIAfterSave();
        }

        /* ===========================
           EXPORTACI√ìN DE DATOS
           =========================== */
        function exportToCSV() {
            const zoneFilter = document.getElementById('zone-filter-global').value;
            let filteredEmployees = employees;
            
            if (zoneFilter !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === zoneFilter);
            }
            
            if (filteredEmployees.length === 0) {
                showNotification('No hay datos para exportar', true);
                return;
            }
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
            
            const headers = ['ID', 'Nombre', 'Sucursal', 'Zona', 'Fecha Inicio', 'Fecha T√©rmino', 'D√≠as Restantes', 'Exp. Ventas', 'Lugar Anterior', 'Curso SAC', 'Video 1', 'Video 2', 'Video 3', 'Video 4', 'Progreso Total', 'Retro 1', 'Calif 1', 'Retro 2', 'Calif 2', 'Suma Total', 'Promedio', 'Estado Final', 'Observaciones'];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                const progress = calculateProgress(emp);
                const totalScore = emp.feedback1 + emp.feedback2;
                const totalCount = (emp.feedback1Completed ? 1 : 0) + (emp.feedback2Completed ? 1 : 0);
                const averageScore = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;
                
                if (emp.status === 'Baja' || emp.status === 'Renuncia') {
                    daysRemaining = 0;
                }
                
                // Formatear Exp. Ventas
                let salesExpText;
                if (emp.hasSalesExperience === true) {
                    salesExpText = 'S√≠';
                } else if (emp.hasSalesExperience === false) {
                    salesExpText = 'No';
                } else {
                    salesExpText = 'PENDIENTE';
                }
                
                // Limpiar observaciones para CSV (eliminar saltos de l√≠nea)
                const observationsCleaned = `"${(emp.observations || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`;


                const row = [
                    emp.id,
                    `"${emp.name}"`,
                    `"${emp.branch}"`,
                    emp.zone,
                    formatDateISO(startDate),
                    formatDateISO(endDate),
                    daysRemaining,
                    salesExpText, // Usa el texto formateado
                    `"${emp.previousWorkplace || ''}"`, 
                    emp.sacCourse ? 'Completado' : 'Pendiente',
                    emp.video1 ? 'Completado' : 'Pendiente',
                    emp.video2 ? 'Completado' : 'Pendiente',
                    emp.video3 ? 'Completado' : 'Pendiente',
                    emp.video4 ? 'Completado' : 'Pendiente',
                    `${progress}%`,
                    emp.feedback1Completed ? 'Completado' : 'Pendiente',
                    emp.feedback1,
                    emp.feedback2Completed ? 'Completado' : 'Pendiente',
                    emp.feedback2,
                    totalScore,
                    averageScore,
                    emp.status,
                    observationsCleaned // NUEVO CAMPO
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // A√±adir el BOM para asegurar que Excel reconozca UTF-8 correctamente
            const BOM = '\uFEFF'; 
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + BOM + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `reporte_capacitacion_${formatDateForFilename(new Date())}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Reporte CSV generado correctamente');
        }

        function generatePDF() {
            const zoneFilter = document.getElementById('zone-filter-global').value;
            let filteredEmployees = employees;
            
            if (zoneFilter !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === zoneFilter);
            }
            
            if (filteredEmployees.length === 0) {
                showNotification('No hay datos para generar PDF', true);
                return;
            }
            
            // Ordenar por fecha de inicio (m√°s antigua primero)
            filteredEmployees.sort((a, b) => (parseDateFromInput(a.startDate) || todayLocal()) - (parseDateFromInput(b.startDate) || todayLocal()));
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Orientaci√≥n horizontal para m√°s columnas
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.text('Reporte de Capacitaci√≥n y Retroalimentaci√≥n', 148, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Fecha de generaci√≥n: ${formatDateISO(todayLocal())}`, 148, 20, { align: 'center' });
            doc.text(`Zona: ${zoneFilter === 'ALL' ? 'Todas' : zoneFilter}`, 148, 25, { align: 'center' });
            
            // Datos para la tabla
            const tableData = [];
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                const progress = calculateProgress(emp);
                const totalScore = emp.feedback1 + emp.feedback2;
                const totalCount = (emp.feedback1Completed ? 1 : 0) + (emp.feedback2Completed ? 1 : 0);
                const averageScore = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;
                
                if (emp.status === 'Baja' || emp.status === 'Renuncia') {
                    daysRemaining = 0;
                }
                
                // Formatear Exp. Ventas
                let salesExpText;
                if (emp.hasSalesExperience === true) {
                    salesExpText = 'S√≠';
                } else if (emp.hasSalesExperience === false) {
                    salesExpText = 'No';
                } else {
                    salesExpText = 'PENDIENTE';
                }

                tableData.push([
                    emp.id,
                    emp.name,
                    emp.branch,
                    emp.zone,
                    formatDateISO(startDate),
                    daysRemaining.toString(),
                    salesExpText, // Usa el texto formateado
                    emp.previousWorkplace, 
                    `${progress}%`,
                    emp.sacCourse ? '‚úì' : '‚úó',
                    emp.video1 ? '‚úì' : '‚úó',
                    emp.video2 ? '‚úì' : '‚úó',
                    emp.video3 ? '‚úì' : '‚úó',
                    emp.video4 ? '‚úì' : '‚úó',
                    emp.feedback1,
                    emp.feedback2,
                    totalScore,
                    averageScore,
                    emp.status,
                    emp.observations || '' // NUEVO CAMPO
                ]);
            });
            
            // Encabezados de la tabla (Ajustar para incluir Observaciones)
            const headers = [
                ['ID', 'Nombre', 'Sucursal', 'Zona', 'Inicio', 'D√≠as', 'Exp. Ventas', 'Lugar Ant.', 'Progreso', 'SAC', 'V1', 'V2', 'V3', 'V4', 'Retro1', 'Retro2', 'Suma', 'Promedio', 'Estatus', 'Obs.']
            ];
            
            // Generar tabla (Ajustar cellWidth para que quepa Obs.)
            doc.autoTable({
                head: headers,
                body: tableData,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5 },
                headStyles: { fillColor: [44, 90, 160], fontSize: 7, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 30, left: 5, right: 5, bottom: 5 },
                columnStyles: {
                    0: { cellWidth: 8 }, // ID
                    1: { cellWidth: 25 }, // Nombre
                    2: { cellWidth: 15 }, // Sucursal
                    3: { cellWidth: 12 }, // Zona
                    4: { cellWidth: 15 }, // Inicio
                    5: { cellWidth: 8 }, // D√≠as
                    6: { cellWidth: 10 }, // Exp. Ventas 
                    7: { cellWidth: 18 }, // Lugar Ant. 
                    8: { cellWidth: 12 }, // Progreso
                    9: { cellWidth: 8 }, // SAC
                    10: { cellWidth: 5 }, // V1
                    11: { cellWidth: 5 }, // V2
                    12: { cellWidth: 5 }, // V3
                    13: { cellWidth: 5 }, // V4
                    14: { cellWidth: 9 }, // Retro1
                    15: { cellWidth: 9 }, // Retro2
                    16: { cellWidth: 9 }, // Suma
                    17: { cellWidth: 11 }, // Promedio
                    18: { cellWidth: 18 },  // Estatus
                    19: { cellWidth: 18 }   // Observaciones (Ajustado)
                }
            });
            
            // Estad√≠sticas al final
            const finalY = doc.lastAutoTable.finalY + 5;
            doc.setFontSize(10);
            doc.text(`Total de empleados: ${filteredEmployees.length}`, 5, finalY);
            
            // Guardar PDF
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Mostrar vista previa
            document.getElementById('pdf-preview-iframe').src = pdfUrl;
            document.getElementById('pdfPreviewModal').style.display = 'block';
        }

        function downloadPDF() {
            // Reutiliza la l√≥gica de generatePDF hasta la generaci√≥n del documento
            const zoneFilter = document.getElementById('zone-filter-global').value;
            let filteredEmployees = employees;
            
            if (zoneFilter !== 'ALL') {
                filteredEmployees = employees.filter(emp => emp.zone === zoneFilter);
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Orientaci√≥n horizontal para m√°s columnas
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.text('Reporte de Capacitaci√≥n y Retroalimentaci√≥n', 148, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Fecha de generaci√≥n: ${formatDateISO(todayLocal())}`, 148, 20, { align: 'center' });
            doc.text(`Zona: ${zoneFilter === 'ALL' ? 'Todas' : zoneFilter}`, 148, 25, { align: 'center' });
            
            // Datos para la tabla
            const tableData = [];
            filteredEmployees.forEach(emp => {
                const startDate = parseDateFromInput(emp.startDate);
                const endDate = parseDateFromInput(emp.endDate);
                const today = todayLocal();
                let daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                const progress = calculateProgress(emp);
                const totalScore = emp.feedback1 + emp.feedback2;
                const totalCount = (emp.feedback1Completed ? 1 : 0) + (emp.feedback2Completed ? 1 : 0);
                const averageScore = totalCount > 0 ? (totalScore / totalCount).toFixed(1) : 0;
                
                if (emp.status === 'Baja' || emp.status === 'Renuncia') {
                    daysRemaining = 0;
                }
                
                // Formatear Exp. Ventas
                let salesExpText;
                if (emp.hasSalesExperience === true) {
                    salesExpText = 'S√≠';
                } else if (emp.hasSalesExperience === false) {
                    salesExpText = 'No';
                } else {
                    salesExpText = 'PENDIENTE';
                }

                tableData.push([
                    emp.id,
                    emp.name,
                    emp.branch,
                    emp.zone,
                    formatDateISO(startDate),
                    daysRemaining.toString(),
                    salesExpText, // Usa el texto formateado
                    emp.previousWorkplace, 
                    `${progress}%`,
                    emp.sacCourse ? '‚úì' : '‚úó',
                    emp.video1 ? '‚úì' : '‚úó',
                    emp.video2 ? '‚úì' : '‚úó',
                    emp.video3 ? '‚úì' : '‚úó',
                    emp.video4 ? '‚úì' : '‚úó',
                    emp.feedback1,
                    emp.feedback2,
                    totalScore,
                    averageScore,
                    emp.status,
                    emp.observations || '' // NUEVO CAMPO
                ]);
            });
            
            // Encabezados de la tabla (Ajustar para incluir Observaciones)
            const headers = [
                ['ID', 'Nombre', 'Sucursal', 'Zona', 'Inicio', 'D√≠as', 'Exp. Ventas', 'Lugar Ant.', 'Progreso', 'SAC', 'V1', 'V2', 'V3', 'V4', 'Retro1', 'Retro2', 'Suma', 'Promedio', 'Estatus', 'Obs.']
            ];
            
            // Generar tabla (Ajustar cellWidth para que quepa Obs.)
            doc.autoTable({
                head: headers,
                body: tableData,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5 },
                headStyles: { fillColor: [44, 90, 160], fontSize: 7, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 30, left: 5, right: 5, bottom: 5 },
                columnStyles: {
                    0: { cellWidth: 8 }, // ID
                    1: { cellWidth: 25 }, // Nombre
                    2: { cellWidth: 15 }, // Sucursal
                    3: { cellWidth: 12 }, // Zona
                    4: { cellWidth: 15 }, // Inicio
                    5: { cellWidth: 8 }, // D√≠as
                    6: { cellWidth: 10 }, // Exp. Ventas 
                    7: { cellWidth: 18 }, // Lugar Ant. 
                    8: { cellWidth: 12 }, // Progreso
                    9: { cellWidth: 8 }, // SAC
                    10: { cellWidth: 5 }, // V1
                    11: { cellWidth: 5 }, // V2
                    12: { cellWidth: 5 }, // V3
                    13: { cellWidth: 5 }, // V4
                    14: { cellWidth: 9 }, // Retro1
                    15: { cellWidth: 9 }, // Retro2
                    16: { cellWidth: 9 }, // Suma
                    17: { cellWidth: 11 }, // Promedio
                    18: { cellWidth: 18 },  // Estatus
                    19: { cellWidth: 18 }   // Observaciones (Ajustado)
                }
            });

            // Estad√≠sticas al final
            const finalY = doc.lastAutoTable.finalY + 5;
            doc.setFontSize(10);
            doc.text(`Total de empleados: ${filteredEmployees.length}`, 5, finalY);

            // Guardar PDF
            doc.save(`reporte_capacitacion_${formatDateForFilename(new Date())}.pdf`);
            showNotification('PDF descargado correctamente');
        }


        function printPDF() {
            const iframe = document.getElementById('pdf-preview-iframe');
            if (!iframe) {
                showNotification('No hay iframe de vista previa del PDF', true);
                return;
            }
            
            const src = iframe.src;
            if (!src) {
                showNotification('No hay PDF cargado para imprimir', true);
                return;
            }

            // Intentar imprimir desde el iframe
            try {
                if (iframe.contentWindow && typeof iframe.contentWindow.print === 'function') {
                    iframe.contentWindow.focus();
                    setTimeout(() => {
                        try {
                            iframe.contentWindow.print();
                        } catch (err) {
                            console.warn('printPDF: print desde contentWindow fall√≥:', err);
                            fallbackOpenAndPrint(src);
                        }
                    }, 200);
                    return;
                }
            } catch (err) {
                console.warn('printPDF: error accediendo a contentWindow:', err);
            }

            // Fallback: abrir en nueva ventana
            fallbackOpenAndPrint(src);
        }

        function fallbackOpenAndPrint(src) {
            const newWin = window.open(src);
            if (!newWin) {
                showNotification('El navegador bloque√≥ la apertura de una nueva ventana. Permita popups e int√©ntelo de nuevo.', true);
                return;
            }
            
            let printed = false;
            const tryPrint = () => {
                try {
                    if (newWin.document.readyState === 'complete' || newWin.document.readyState === 'interactive') {
                        newWin.focus();
                        try {
                            newWin.print();
                            printed = true;
                        } catch (err) {
                            console.warn('fallbackOpenAndPrint: error al imprimir en la nueva ventana', err);
                            showNotification('No se pudo imprimir el PDF desde la nueva ventana.', true);
                        }
                    }
                } catch (err) {
                    console.warn('fallbackOpenAndPrint: error comprobando readyState', err);
                }
            };

            newWin.addEventListener ? newWin.addEventListener('load', tryPrint) : (newWin.onload = tryPrint);
            setTimeout(() => { if (!printed) tryPrint(); }, 1500);
        }

        function closePdfPreview() {
            const modal = document.getElementById('pdfPreviewModal');
            const iframe = document.getElementById('pdf-preview-iframe');
            if (iframe && iframe.src) {
                try { 
                    URL.revokeObjectURL(iframe.src); 
                } catch (e) { 
                    // Ignorar errores al revocar URL
                }
                iframe.src = '';
            }
            if (modal) modal.style.display = 'none';
        }

        function forceSaveNow() {
            saveData();
        }

        /* ===========================
           GUARDADO EN FIREBASE / LOCAL
           =========================== */
        function saveData() {
            // Guardar en Firebase si est√° conectado, si no usar almacenamiento local
            if (firebaseConnected) {
                try {
                    // Convertir el array a objeto para Firebase
                    const employeesObj = {};
                    employees.forEach(emp => {
                        employeesObj[emp.id] = emp;
                    });
                    
                    employeesRef.set(employeesObj)
                        .then(() => {
                            lastSaveTime = new Date();
                            showNotification('Datos guardados en la nube correctamente');
                            saveToLocalStorage(); // Tambi√©n guardar localmente como respaldo
                        })
                        .catch(error => {
                            console.error('Error guardando en Firebase:', error);
                            // Fallback a almacenamiento local
                            if (saveToLocalStorage()) {
                                showNotification('Datos guardados localmente (error de conexi√≥n)', true);
                            } else {
                                showNotification('Error guardando datos', true);
                            }
                        });
                } catch (error) {
                    console.error('Error en saveData:', error);
                    saveToLocalStorage();
                    showNotification('Datos guardados localmente (error inesperado)', true);
                }
            } else {
                if (saveToLocalStorage()) {
                    showNotification('Datos guardados localmente (sin conexi√≥n)');
                } else {
                    showNotification('Error guardando datos localmente', true);
                }
            }
        }
        
        /* ===========================
           NUEVAS FUNCIONES DE ADMINISTRACI√ìN
           =========================== */
        function backupData() {
            if (currentUser && currentUser.email === 'EDUARDO.MASTER@UNIVERSIDADPRESTOCASH.MX') {
                const dataStr = JSON.stringify(employees, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `copia_de_seguridad_${formatDateForFilename(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Copia de seguridad generada correctamente.');
            } else {
                showNotification('No tiene permisos para realizar esta acci√≥n.', true);
            }
        }

        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Por favor, seleccione un archivo JSON para restaurar.', true);
                return;
            }
            
            if (!confirm('¬øEst√° seguro de que desea restaurar la base de datos? Esto eliminar√° todos los datos actuales.')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const restoredData = JSON.parse(event.target.result);
                    // Validar la estructura del archivo JSON
                    if (!Array.isArray(restoredData) || restoredData.some(emp => !emp.id)) {
                        throw new Error('El archivo no tiene el formato correcto.');
                    }
                    
                    employees = restoredData;
                    saveData();
                    showNotification('Base de datos restaurada correctamente.');
                    closePasswordModal();
                } catch (e) {
                    console.error('Error al procesar el archivo de restauraci√≥n:', e);
                    showNotification('Error: El archivo no es un formato de copia de seguridad v√°lido.', true);
                }
            };
            reader.readAsText(file);
        }

        /* ===========================
           RESET DE DATOS (AHORA CON MODAL UNIFICADO)
           =========================== */
        function showPasswordModal(action) {
            currentAction = action;
            const title = document.getElementById('password-modal-title');
            const message = document.getElementById('password-modal-message');
            const button = document.getElementById('password-modal-button');
            
            if (action === 'reset') {
                title.textContent = "Restablecer Datos";
                message.textContent = "Esta acci√≥n eliminar√° todos los datos y restablecer√° el sistema a valores predeterminados.";
                button.textContent = "Confirmar Restablecimiento";
                button.className = "btn btn-danger";
            } else if (action === 'restore') {
                title.textContent = "Restaurar Base de Datos";
                message.textContent = "Esta acci√≥n sobrescribir√° la base de datos con los datos de la copia de seguridad.";
                button.textContent = "Confirmar Restauraci√≥n";
                button.className = "btn btn-warning";
            }
            
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('reset-password').value = '';
            document.getElementById('password-error').style.display = 'none';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function confirmAction() {
            const password = document.getElementById('reset-password').value;
            if (currentUser && users[currentUser.email] && users[currentUser.email].password === password) {
                if (currentAction === 'reset') {
                    resetData();
                } else if (currentAction === 'restore') {
                    restoreData();
                }
            } else {
                document.getElementById('password-error').style.display = 'block';
            }
        }

        function resetData() {
            if (!confirm('¬øEST√Å SEGURO? Esta acci√≥n eliminar√° TODOS los datos y no se puede deshacer.')) {
                closePasswordModal();
                return;
            }
            
            // Crear empleado de ejemplo con c√°lculo correcto de fechas (90 d√≠as contando inicio)
            const start = todayLocal();
            const end = new Date(start);
            end.setDate(end.getDate() + 89); // +89 para contar d√≠a inicial
            
            const exampleEmployee = {
                id: "1",
                name: "EJEMPLO - AGREGUE NUEVOS EMPLEADOS",
                branch: "SUCURSAL-01",
                zone: 'ZONA 1',
                startDate: formatDateISO(start),
                endDate: formatDateISO(end),
                sacCourse: false,
                video1: false,
                video2: false,
                video3: false,
                video4: false,
                feedback1: 0,
                feedback2: 0,
                feedback1Completed: false,
                feedback2Completed: false,
                status: 'En proceso',
                hasSalesExperience: 'PENDIENTE', // Valor inicial por defecto
                previousWorkplace: '', 
                observations: '',
            };
            
            employees = [exampleEmployee];
            saveData();
            showNotification('Datos restablecidos correctamente');
            closePasswordModal();
        }

        /* ===========================
           FUNCIONES UTILITARIAS
           =========================== */
        function formatDateForFilename(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}`;
        }

        function toUpperCaseSafe(str) {
            if (typeof str !== 'string') return '';
            return str.toUpperCase();
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById(isError ? 'errorNotification' : 'saveNotification');
            const textElement = document.getElementById(isError ? 'error-text' : 'notification-text');
            
            textElement.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        /* ===========================
           INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
           =========================== */
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Prevenir cambio de tab si no tiene permisos
                    if (tab.classList.contains('access-denied')) {
                        showNotification("No tiene permisos para acceder a esta secci√≥n.", true);
                        return;
                    }

                    const target = tab.getAttribute('data-target');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');

                    // Llamar a la funci√≥n de actualizaci√≥n espec√≠fica para la pesta√±a de An√°lisis si es la seleccionada
                    if (target === 'analytics') {
                        updateAnalyticsTab();
                    }
                });
            });
            
            // Verificar si hay una sesi√≥n existente
            checkExistingSession();
            
            // Actualizar UI cada minuto para recalcular d√≠as restantes
            setInterval(updateUIAfterSave, 60000);
        });
    </script>
</body>
</html>
